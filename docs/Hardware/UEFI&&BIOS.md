## 电流开天辟地

计算级启动分为内核加载前，内核加载时和加载后这三个阶段，这三个阶段又可以分为很多小阶段。

[CentOS 6开机流程(MBR+SysV) | 骏马金龙 (junmajinlong.com)](https://www.junmajinlong.com/linux/boot_process_bios_mbr/)

### 电子转移支付

> 注： 不管是uefi 还是bios ，启动的核心还是一样的， 
>
> 上电后，硬件暂时无法被识别，主板上指定的代码段会被执行，（uefi固件或者
>
> 1.  rom 运行代码，准备初始化环境
> 2. 初始化各种硬件，芯片组，cpu，主板模块
>
> 晶振： 一种振荡器原件，实现能量转换，频率控制等功能

1. 接电

    系统电源进入待机等待状态，并将电源指定针脚输出指定电压，（称为开机控制电压）电源进入待机状态

2. 开机
    当短接开机触发排针之后，南桥通电，cmos检测到电压跳变，南桥发送控制指令到io芯片，将开机控制电压拉低并保持为零，电源电压跳变后进入工作状态，给电源上的针脚输出指定的电压，给硬件供电。

3. 电源自检

    检测电源输出无短路、漏电等异常情况，如有，切断电压输出，进行自我保护。如反馈正常，电源在指定针脚上输出PG信号给它需要的原件。此时，电源IC开始进行稳定供电

4. -
    PG信号反馈正常的情况下，电源IC发出高频控制信号给CPU，让CPU MOS管导通，满足CPU的供电
    同时，时钟芯片开始工作，将晶振产生的频率处理后输送给个个原件，cpu频率和时钟正常工作后经过各种转换的PG信号变成复位信号输送给北桥芯片（主板bios控制器的一部分），供电、时钟、复位都正常工作后，将南桥芯片的复位信号处理后发送给CPU，此时CPU开始正常工作

5. 寻址（BIOS）
    CPU 发出指令找BIOS芯片（BIOS芯片连接主板个个部分（包含两种软件部分，UEFI或者BIOS ，都是软件层面的抽象）），指令通过北桥到达南桥，南桥（PCI插槽上产生高频脉冲波形，帧信号）到达BIOS（指定引脚产生高频脉冲波形，片选信号）。 找到BIOS后，调取BIOS内部保存好的程序返回给CPU执行（自检）

6. 查找显卡BIOS

7. 枚举设备，开始移交工作，进入操作系统时代的引路人在此出现。

### MBR与bootloader阶段

识别启动设备

### 分区表

硬盘分区的好处之一就是可以在不同的分区中安装不同的操作系统，但boot loader必须要知道每个操作系统具体是在哪个分区。

分区表的长度只有64个字节，里面又分成四项，每项16个字节。所以，一个硬盘最多只能分四个主分区。

每个主分区表项的16个字节，都由6个部分组成：

(1).第1个字节：只能为0或者0x80。0x80表示该主分区是激活分区，0表示非激活分区。单磁盘只能有一个主分区是激活的。

(2).第2-4个字节：主分区第一个扇区的物理位置（柱面、磁头、扇区号等等）。

(3).第5个字节：主分区类型。

(4).第6-8个字节：主分区最后一个扇区的物理位置。

(5).第9-12字节：该主分区第一个扇区的逻辑地址。

(6).第13-16字节：主分区的扇区总数。

最后的四个字节『主分区的扇区总数』，决定了这个主分区的长度。也就是说，一个主分区的扇区总数最多不超过2的32次方。如果每个扇区为512个字节，就意味着单个分区最大不超过2TB。

### VBR/EBR引导

- 如果查找分区表时发现某个主分区表的第一个字节是0x80，也就是激活的分区，那么说明操作系统装在了该主分区，然后执行已载入的MBR中的boot loader代码，加载该激活主分区的VBR中的boot loader，至此，控制权就交给了VBR的boot loader了；
- 如果操作系统不是装在主分区，那么肯定是装在逻辑分区中，所以查找完主分区表后会继续查找扩展分区表，直到找到EBR所在的分区，然后MBR中的boot loader将控制权交给该EBR的boot loader。

### GRUB引导

...

总结下，从MBR开始后的过程是这样的：

1.执行MBR中的boot loader(即boot.img)跳转到diskboot.img。
2.执行diskboot.img，加载core.img剩余的部分，并跳转到kernel.img。
3.kernel.img读取/boot/grub2/grub2.cfg，并显示启动管理菜单。
4.选中某菜单后，kernel.img加载该菜单项配置的操作系统内核/boot/vmlinux-XXX，并传递内核启动参数，包括根文件系统所在分区和init ramdisk的路径。
5.控制权交给操作系统内核。

操作系统的时代正式开始。

